<!DOCTYPE html>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<!-- 부트스트랩 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- 부트스트랩 5 자바스크립트 및 의존성 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>simpleMap</title>
	<style>
		#sidebar {
			width: 250px;
			height: 100%;
			background-color: #f2f2f2;
			padding: 20px;
			position: fixed;
			top: 0;
			left: 0;
			overflow-y: auto;
		}


		.savebutton {
			margin-left: 500px;
		}

		.ft_select_wrap {
			float: right;
		}

		.map_result {
			float: right;
		}

		/* 팝업 창 스타일 */
		.popup {
			display: none;
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background-color: white;
			padding: 20px;
			border: 1px solid black;
			border-radius: 5px;
			z-index: 1000;
		}

		/* 달력 스타일 */
		#calendar {
			display: none;
			position: absolute;
			background-color: #fff;
			border: 1px solid #ccc;
			padding: 10px;
			z-index: 1000;
		}

		#map_wrap {
			margin-left: 420px;
			/* Adjust the margin to leave space for the sidebar */
			width: calc(100% - 320px);
			/* Adjust the width to fit the remaining space */
			height: 80vh;
			/* Set the height to 100% of the viewport height */
			margin-bottom: 100px;
		}

		/* sidebar 내의 각 여행지 정보를 스타일링하기 위한 스타일 */
		.sidebar-item {
			margin-bottom: 10px;
			cursor: pointer;
		}

		/* 작은 화면을 나타내는 div 요소의 스타일 */
		#smallScreen {
			display: none;
			/* 초기에는 숨겨짐 */
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background-color: white;
			padding: 20px;
			border: 1px solid black;
			border-radius: 5px;
			z-index: 1000;
		}

		.day-marker {
			pointer-events: none;
		}

		/* 작은 화면을 나타내는 div 요소의 스타일 */
		#addTourScreen {
			display: none;
			/* 초기에는 숨겨짐 */
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background-color: white;
			padding: 20px;
			border: 1px solid black;
			border-radius: 5px;
			z-index: 1000;
		}
	</style>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script
		src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=6VYbMDkEY24DlbC0m8ymh1ESimWVROyI3sP7PqT1"></script>
	<script type="text/javascript">

		var map;
		//자동차 경로 안
		var markerInfo;
		//출발지,도착지 마커
		var marker_s, marker_e, marker_p;
		//경로그림정보
		var drawInfoArr = [];
		var drawInfoArr2 = [];

		var chktraffic = [];
		var resultdrawArr = [];  //라인 
		var resultMarkerArr = [];

		//자동차, 도보 
		var selectedTransportMode = "";
		// Tmap api를 통한 경로의 거리와 이동 시간을 담을 객체.  
		var transportData = {};

		// 여행 일정 저장 객체
		let itinerary = [];
		var user1 = "user1";

		var map, marker;
		var lonlat;
		var markers = [];
		var addTourEnabled = false; // 전역 변수로 선언합니다.

		// 페이지가 로딩이 된 후 호출하는 함수입니다.
		function initTmap() {
			// map 생성
			// Tmapv2.Map을 이용하여, 지도가 들어갈 div, 넓이, 높이를 설정합니다.
			map = new Tmapv2.Map("map_div", { // 지도가 생성될 div
				center: new Tmapv2.LatLng(35.3116461479475, 128.679897664909),
				width: "800px", // 지도의 넓이
				height: "700px", // 지도의 높이
				zoom: 14
			});

			/*
						// DB에서 가져온 여행지 정보 (예시)
						var places = [
							{name: '주남저수지', latitude: 35.3116461479475, longitude: 128.679897664909, description: "주남저수지 설명 Lorem ipsum dolor sit amet."},
							{name: '돌다리', latitude: 35.3302837564477, longitude: 128.696624997296, description: "돌다리 설명 Lorem ipsum dolor sit amet."},
							{name: '여행', latitude: 35.3402837564477, longitude: 128.676624997296, description: "돌다리 설명 Lorem ipsum dolor sit amet."},
							// 추가 여행지 정보 추가
						]; */

			// 새로 추가된 여행지 정보를 저장할 배열
			var newPlaces = [];

			var sidebar = document.getElementById('sidebar');
			var smallScreen = document.getElementById('smallScreen');
			var addTourScreen = document.getElementById('addTourScreen');

			//여행지 추가
			//map.addListener("click", addTour); //map 클릭 이벤트를 등록합니다.
			map.addListener("click", function (e) {
				if (addTourEnabled) {
					addTour(e.latLng);
				}
			});
			// DB에서 가져온 여행지 정보
			$.ajax({
				url: 'route/gettour',
				type: 'GET',
				dataType: 'json',
				success: function (data) {
					// 가져온 데이터를 places 변수에 할당
					var places = data;

					// places 변수를 이용하여 원하는 작업을 수행
					console.log("place");
					console.log(places); // 가져온 데이터 확인

					//여행지 마커 생성 및 추가
					places.forEach(function (place) {

						var marker = new Tmapv2.Marker({
							position: new Tmapv2.LatLng(place.lattitue, place.longtitue),
							map: map,
							title: place.name
						});
						console.log("not");
						// Marker에 클릭 이벤트 등록
						marker.addListener("click", function (evt) {
							showSmallScreen(place);
						});
					});
				}
			})


			// 작은 화면을 표시하는 함수
			function showSmallScreen(place) {
				// 작은 화면을 나타내는 div 요소 가져오기
				var smallScreen = document.getElementById("smallScreen");

				// 작은 화면 보이기
				smallScreen.style.display = "block";

				// 여행지 정보 표시
				document.getElementById('placeName').textContent = place.tourName;
				document.getElementById('placeDescription').textContent = place.tourContent;

				// "추가" 버튼 클릭 시 sidebar에 여행지 정보 newPlaces 배열에 추가
				document.getElementById('addToSidebarButton').onclick = function () {
					newPlaces.push(place);
					console.log(newPlaces);
					createTransportButtons(newPlaces.length - 1);
					addToSidebar(place.tourName);
				};
			}


			// 이전 여행지와 현재 여행지 사이의 교통 정보 버튼 생성 함수
			function createTransportButtons(index) {
				if (index > 0) {
					const transportDiv = document.createElement('div');
					transportDiv.classList.add('transport-buttons');

					// 자동차 버튼
					const carButton = document.createElement('button');
					carButton.textContent = '자동차';
					carButton.classList.add('get-transport-info');
					carButton.onclick = onTransportButtonClick('자동차', index);

					/*
					carButton.onclick = function () {
						selectedTransportMode = '자동차';
						 const transportInfo = getTransportInfoBetweenPlaces(newPlaces[index - 1], newPlaces[index]);
						updateItinerary(transportInfo);
					} */

					// 도보 버튼
					const walkButton = document.createElement('button');
					walkButton.textContent = '도보';
					walkButton.classList.add('get-transport-info');
					walkButton.onclick = onTransportButtonClick('도보', index);
					/*
					walkButton.onclick = function () {
						selectedTransportMode = '도보';
						 const transportInfo = getWalkInfoBetweenPlaces(newPlaces[index - 1], newPlaces[index]);
						updateItinerary(transportInfo);
					}; */

					transportDiv.appendChild(carButton);
					transportDiv.appendChild(walkButton);


					const sidebar = document.getElementById('sidebar');
					const listItem = sidebar.lastChild;
					listItem.appendChild(transportDiv);
				}
			}

			// 도보 또는 자동차 버튼 클릭 시 호출되는 함수
			function onTransportButtonClick(transportMode, index) {
				return function () {
					selectedTransportMode = transportMode;
					let transportInfo;
					if (transportMode === '자동차') {
						transportInfo = getTransportInfoBetweenPlaces(newPlaces[index - 1], newPlaces[index]);
					} else if (transportMode === '도보') {
						transportInfo = getWalkInfoBetweenPlaces(newPlaces[index - 1], newPlaces[index]);
					}

					// 결과를 담을 컨테이너를 생성합니다.
					const resultContainer = document.createElement('div');
					resultContainer.classList.add('result-container');
					resultContainer.textContent = "거리 : " + `${transportInfo.tDistance}` + "km, 소요 시간 : " + `${transportInfo.tTime}` + "분 "; // 예시로 tDistance와 tTime을 사용했습니다.

					// 버튼과 결과 컨테이너를 감싸고 있는 div 요소를 찾습니다.
					const containerDiv = this.parentNode;

					// 이전에 추가된 결과 컨테이너가 있다면 삭제합니다.
					const previousResultContainer = containerDiv.querySelector('.result-container');
					if (previousResultContainer) {
						containerDiv.removeChild(previousResultContainer);
					}

					// 자동차 또는 도보 버튼 옆에 결과 값을 추가합니다.
					containerDiv.insertBefore(resultContainer, this.nextSibling);

					// 클릭된 버튼의 배경색 변경
					this.style.backgroundColor = 'lightblue';

					// 나머지 버튼의 배경색을 초기화
					const buttons = document.querySelectorAll('.get-transport-info');
					buttons.forEach(button => {
						if (button !== this) {
							button.style.backgroundColor = ''; // 초기화
						}
					});

					addItineraryInfo(transportInfo, index);
					updateItinerary(transportInfo);
				};
			}

			// 여행 정보를 itinerary 배열에 추가하는 함수
			function addItineraryInfo(transportInfo, index) {
				itinerary[index] = {
					routeName: "창원1",
					routeTraffic: selectedTransportMode,
					routeDistance: transportInfo.tDistance,
					routeTime: transportInfo.tTime,
					routeStartLocation: newPlaces[index - 1].tourName,
					routeEndLocation: newPlaces[index].tourName,
					//routeUserId: user1, // 유저 아이디는 임시로 1로 설정됨
					routeStartLatitude: newPlaces[index - 1].lattitue,
					routeStartLongitude: newPlaces[index - 1].longtitue,
					routeEndLatitude: newPlaces[index].lattitue,
					routeEndLongitude: newPlaces[index].longtitue,
					routeOrder: index
				};
			}

			// 여행 일정 업데이트 함수 수정
			function updateItinerary(transportInfo) {
				const currentIndex = newPlaces.length - 1;
				itinerary[currentIndex] = {
					routeName: "창원1",
					routeTraffic: selectedTransportMode,
					routeDistance: transportInfo.tDistance,
					routeTime: transportInfo.tTime,
					routeStartLocation: newPlaces[currentIndex - 1].tourName,
					routeEndLocation: newPlaces[currentIndex].tourName,
					//routeUserId: user1, // 유저 아이디는 임시로 1로 설정됨
					routeStartLatitude: newPlaces[currentIndex - 1].lattitue,
					routeStartLongitude: newPlaces[currentIndex - 1].longtitue,
					routeEndLatitude: newPlaces[currentIndex].lattitue,
					routeEndLongitude: newPlaces[currentIndex].longtitue,
					routeOrder: currentIndex
				};
			}

			// 여행 일정 저장 함수
			function saveItinerary() {

				console.log(itinerary);

				// 각 일정을 순회하면서 서버로 데이터 전송
				itinerary.forEach(function (item) {
					$.ajax({
						method: "POST",
						url: "/route/save",
						data: JSON.stringify(item),
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function (response) {
							console.log(response.message);
							console.log("여행 일정이 저장되었습니다.html");
							window.location.href = "/route/list";
						},
						error: function (request, status, error) {
							console.log("여행 일정 저장에 실패했습니다html");
							console.log(request); // 요청 정보 확인
							console.log(status); // 상태 코드 확인
							console.log(error); // 오류 메시지 확인
						}
					});
				});
			}

			// 여행 일정 저장 버튼 클릭 이벤트 핸들러
			document.getElementById('saveItineraryButton').onclick = saveItinerary;

			//sidebar
			function addToSidebar(placeName) {

				//sidebar에 여행지 정보 추가하는 함수
				var listItem = document.createElement('div');
				listItem.textContent = placeName;
				listItem.classList.add('sidebar-item'); // sidebar-item 클래스 추가
				sidebar.appendChild(listItem);

				// 추가된 여행지 삭제 버튼
				var deleteButton = document.createElement('button');
				deleteButton.textContent = 'Delete';
				deleteButton.classList.add('delete-button');
				listItem.appendChild(deleteButton);
			}

			function getWalkInfoBetweenPlaces(place1, place2) {
				// 2. 시작, 도착 심볼찍기
				// 시작
				marker_s = new Tmapv2.Marker(
					{
						position: new Tmapv2.LatLng(37.564991, 126.983937),
						icon: "/images/pin_r_m_s.png",
						iconSize: new Tmapv2.Size(24, 38),
						map: map
					});

				// 도착
				marker_e = new Tmapv2.Marker(
					{
						position: new Tmapv2.LatLng(37.566158, 126.988940),
						icon: "/images/pin_r_m_e.png",
						iconSize: new Tmapv2.Size(24, 38),
						map: map
					});

				// 3. 경로탐색 API 사용요청
				var headers = {};
				headers["appKey"] = "6VYbMDkEY24DlbC0m8ymh1ESimWVROyI3sP7PqT1";

				$.ajax({
					method: "POST",
					headers: headers,
					url: "https://apis.openapi.sk.com/tmap/routes/pedestrian?version=1&format=json&callback=result",
					async: false,
					data: {
						"startX": place1.longtitue,
						"startY": place1.lattitue,
						"endX": place2.longtitue,
						"endY": place2.lattitue,
						"reqCoordType": "WGS84GEO",
						"resCoordType": "EPSG3857",
						"startName": "출발지",
						"endName": "도착지"
					},
					success: function (response) {
						var resultData = response.features;

						transportData.tDistance =
							((resultData[0].properties.totalDistance) / 1000)
								.toFixed(1);

						transportData.tTime =
							((resultData[0].properties.totalTime) / 60)
								.toFixed(0);


						//기존 그려진 라인 & 마커가 있다면 초기화
						if (resultdrawArr.length > 0) {
							for (var i in resultdrawArr) {
								resultdrawArr[i]
									.setMap(null);
							}
							resultdrawArr = [];
						}

						drawInfoArr = [];

						for (var i in resultData) { //for문 [S]
							var geometry = resultData[i].geometry;
							var properties = resultData[i].properties;
							var polyline_;


							if (geometry.type == "LineString") {
								for (var j in geometry.coordinates) {
									// 경로들의 결과값(구간)들을 포인트 객체로 변환 
									var latlng = new Tmapv2.Point(
										geometry.coordinates[j][0],
										geometry.coordinates[j][1]);
									// 포인트 객체를 받아 좌표값으로 변환
									var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
										latlng);
									// 포인트객체의 정보로 좌표값 변환 객체로 저장
									var convertChange = new Tmapv2.LatLng(
										convertPoint._lat,
										convertPoint._lng);
									// 배열에 담기
									drawInfoArr.push(convertChange);
								}
							} else {
								var markerImg = "";
								var pType = "";
								var size;

								if (properties.pointType == "S") { //출발지 마커
									markerImg = "/images/pin_r_m_s.png";
									pType = "S";
									size = new Tmapv2.Size(24, 38);
								} else if (properties.pointType == "E") { //도착지 마커
									markerImg = "/images/pin_r_m_e.png";
									pType = "E";
									size = new Tmapv2.Size(24, 38);
								} else { //각 포인트 마커
									//markerImg = "http://topopen.tmap.co.kr/imgs/point.png";
									pType = "P";
									size = new Tmapv2.Size(0, 0);
								}

								// 경로들의 결과값들을 포인트 객체로 변환 
								var latlon = new Tmapv2.Point(
									geometry.coordinates[0],
									geometry.coordinates[1]);

								// 포인트 객체를 받아 좌표값으로 다시 변환
								var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
									latlon);

								var routeInfoObj = {
									markerImage: markerImg,
									lng: convertPoint._lng,
									lat: convertPoint._lat,
									pointType: pType
								};

								// Marker 추가
								marker_p = new Tmapv2.Marker(
									{
										position: new Tmapv2.LatLng(
											routeInfoObj.lat,
											routeInfoObj.lng),
										icon: routeInfoObj.markerImage,
										iconSize: size,
										map: map
									});
							}
						}//for문 [E]
						drawLine(drawInfoArr);
					},
					error: function (request, status, error) {
						console.log("code:" + request.status + "\n"
							+ "message:" + request.responseText + "\n"
							+ "error:" + error);
					}
				});

				return transportData;
			}


			function getTransportInfoBetweenPlaces(place1, place2) {
				// 2. 시작, 도착 심볼찍기
				// 시작
				marker_s = new Tmapv2.Marker({
					position: new Tmapv2.LatLng(place1.latitude,
						place1.longitude),
					icon: "/images/pin_r_m_s.png",
					iconSize: new Tmapv2.Size(24, 38),
					map: map
				});

				//도착
				marker_e = new Tmapv2.Marker({
					position: new Tmapv2.LatLng(place2.latitude,
						place2.longitude),
					icon: "/images/pin_r_m_e.png",
					iconSize: new Tmapv2.Size(24, 38),
					map: map
				});
				console.log("markere : {}", marker_e);

				//기존 맵에 있던 정보들 초기화
				resettingMap();

				var searchOption = $("#selectLevel").val();

				var trafficInfochk = $("#year").val();
				var headers = {};
				headers["appKey"] = "6VYbMDkEY24DlbC0m8ymh1ESimWVROyI3sP7PqT1";

				//JSON TYPE EDIT [S]
				$.ajax({
					type: "POST",
					headers: headers,
					url: "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result&appKey=6VYbMDkEY24DlbC0m8ymh1ESimWVROyI3sP7PqT1",
					async: false,
					data: {
						"startX": place1.longtitue,
						"startY": place1.lattitue,
						"endX": place2.longtitue,
						"endY": place2.lattitue,
						"reqCoordType": "WGS84GEO",
						"resCoordType": "EPSG3857",
						"searchOption": searchOption,
						"trafficInfo": trafficInfochk
					},
					success: function (response) {

						var resultData = response.features;

						transportData.tDistance =
							((resultData[0].properties.totalDistance) / 1000)
								.toFixed(1);

						transportData.tTime =
							((resultData[0].properties.totalTime) / 60)
								.toFixed(0);

						for (var i in resultData) { //for문 [S]
							var geometry = resultData[i].geometry;
							var properties = resultData[i].properties;

							if (geometry.type == "LineString") {
								for (var j in geometry.coordinates) {
									// 경로들의 결과값들을 포인트 객체로 변환 
									var latlng = new Tmapv2.Point(
										geometry.coordinates[j][0],
										geometry.coordinates[j][1]);
									// 포인트 객체를 받아 좌표값으로 변환
									var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
										latlng);
									// 포인트객체의 정보로 좌표값 변환 객체로 저장
									var convertChange = new Tmapv2.LatLng(
										convertPoint._lat,
										convertPoint._lng);
									// 배열에 담기
									drawInfoArr
										.push(convertChange);
								}
								drawLine(drawInfoArr,
									"0");
							} else {

								var markerImg = "";
								var pType = "";

								if (properties.pointType == "S") { //출발지 마커
									markerImg = "/images/pin_r_m_s.png";
									pType = "S";
								} else if (properties.pointType == "E") { //도착지 마커
									markerImg = "/images/pin_r_m_e.png";
									pType = "E";
								} else { //각 포인트 마커
									//markerImg = "http://topopen.tmap.co.kr/imgs/point.png";
									pType = "P"
								}

								// 경로들의 결과값들을 포인트 객체로 변환 
								var latlon = new Tmapv2.Point(
									geometry.coordinates[0],
									geometry.coordinates[1]);
								// 포인트 객체를 받아 좌표값으로 다시 변환
								var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
									latlon);

								var routeInfoObj = {
									markerImage: markerImg,
									lng: convertPoint._lng,
									lat: convertPoint._lat,
									pointType: pType
								};

								// Marker 추가
								addMarkers(routeInfoObj);
							}
						}//for문 [E]

					},
					error: function (request, status, error) {
						console.log("code:"
							+ request.status + "\n"
							+ "message:"
							+ request.responseText
							+ "\n" + "error:" + error);
					}
				});
				return transportData;

			}//end getTransportInfoBetweenPlaces


			// 추가된 여행지를 삭제하거나 이동하는 함수들
			function handleSidebarActions(event) {
				const target = event.target;
				const listItem = target.parentElement;
				if (target.classList.contains("delete-button")) {
					newPlaces.pop();

					sidebar.removeChild(listItem);
				}
			}

			// 삭제 및 이동 버튼 클릭 이벤트를 sidebar에 등록
			sidebar.addEventListener("click", handleSidebarActions);

			// "1day" 항목 추가
			var dayMarker = document.createElement('div');
			dayMarker.textContent = '1day';
			dayMarker.classList.add('sidebar-item', 'day-marker'); // day-marker 클래스 추가
			sidebar.appendChild(dayMarker);


			// 초기화: 작은 화면을 클릭하면 숨김
			document.getElementById("smallScreen").addEventListener("click", function () {
				this.style.display = "none";
			});

		} //end map

		function addComma(num) {
			var regexp = /\B(?=(\d{3})+(?!\d))/g;
			return num.toString().replace(regexp, ',');
		}

		//마커 생성하기
		function addMarkers(infoObj) {
			var size = new Tmapv2.Size(24, 38);//아이콘 크기 설정합니다.

			if (infoObj.pointType == "P") { //포인트점일때는 아이콘 크기를 줄입니다.
				size = new Tmapv2.Size(0, 0);
			}

			marker_p = new Tmapv2.Marker({
				position: new Tmapv2.LatLng(infoObj.lat, infoObj.lng),
				icon: infoObj.markerImage,
				iconSize: size,
				map: map
			});

			resultMarkerArr.push(marker_p);
		}

		//도보 라인 그리기
		function drawLine(arrPoint) {
			var polyline_;

			polyline_ = new Tmapv2.Polyline({
				path: arrPoint,
				strokeColor: "#DD0000",
				strokeWeight: 6,
				map: map
			});
			resultdrawArr.push(polyline_);
		}

		//라인그리기
		function drawLine(arrPoint, traffic) {
			var polyline_;
			console.log("라인 그리기");

			if (chktraffic.length != 0) {

				// 교통정보 혼잡도를 체크
				// strokeColor는 교통 정보상황에 다라서 변화
				// traffic :  0-정보없음, 1-원활, 2-서행, 3-지체, 4-정체  (black, green, yellow, orange, red)

				var lineColor = "";

				if (traffic != "0") {
					if (traffic.length == 0) { //length가 0인것은 교통정보가 없으므로 검은색으로 표시

						lineColor = "#06050D";
						//라인그리기[S]
						polyline_ = new Tmapv2.Polyline({
							path: arrPoint,
							strokeColor: lineColor,
							strokeWeight: 6,
							map: map
						});
						resultdrawArr.push(polyline_);
						//라인그리기[E]
					} else { //교통정보가 있음

						if (traffic[0][0] != 0) { //교통정보 시작인덱스가 0이 아닌경우
							var trafficObject = "";
							var tInfo = [];

							for (var z = 0; z < traffic.length; z++) {
								trafficObject = {
									"startIndex": traffic[z][0],
									"endIndex": traffic[z][1],
									"trafficIndex": traffic[z][2],
								};
								tInfo.push(trafficObject)
							}

							var noInfomationPoint = [];

							for (var p = 0; p < tInfo[0].startIndex; p++) {
								noInfomationPoint.push(arrPoint[p]);
							}

							//라인그리기[S]
							polyline_ = new Tmapv2.Polyline({
								path: noInfomationPoint,
								strokeColor: "#06050D",
								strokeWeight: 6,
								map: map
							});
							//라인그리기[E]
							resultdrawArr.push(polyline_);

							for (var x = 0; x < tInfo.length; x++) {
								var sectionPoint = []; //구간선언

								for (var y = tInfo[x].startIndex; y <= tInfo[x].endIndex; y++) {
									sectionPoint.push(arrPoint[y]);
								}

								if (tInfo[x].trafficIndex == 0) {
									lineColor = "#06050D";
								} else if (tInfo[x].trafficIndex == 1) {
									lineColor = "#61AB25";
								} else if (tInfo[x].trafficIndex == 2) {
									lineColor = "#FFFF00";
								} else if (tInfo[x].trafficIndex == 3) {
									lineColor = "#E87506";
								} else if (tInfo[x].trafficIndex == 4) {
									lineColor = "#D61125";
								}

								//라인그리기[S]
								polyline_ = new Tmapv2.Polyline({
									path: sectionPoint,
									strokeColor: lineColor,
									strokeWeight: 6,
									map: map
								});
								//라인그리기[E]
								resultdrawArr.push(polyline_);
							}
						} else { //0부터 시작하는 경우

							var trafficObject = "";
							var tInfo = [];

							for (var z = 0; z < traffic.length; z++) {
								trafficObject = {
									"startIndex": traffic[z][0],
									"endIndex": traffic[z][1],
									"trafficIndex": traffic[z][2],
								};
								tInfo.push(trafficObject)
							}

							for (var x = 0; x < tInfo.length; x++) {
								var sectionPoint = []; //구간선언

								for (var y = tInfo[x].startIndex; y <= tInfo[x].endIndex; y++) {
									sectionPoint.push(arrPoint[y]);
								}

								if (tInfo[x].trafficIndex == 0) {
									lineColor = "#06050D";
								} else if (tInfo[x].trafficIndex == 1) {
									lineColor = "#61AB25";
								} else if (tInfo[x].trafficIndex == 2) {
									lineColor = "#FFFF00";
								} else if (tInfo[x].trafficIndex == 3) {
									lineColor = "#E87506";
								} else if (tInfo[x].trafficIndex == 4) {
									lineColor = "#D61125";
								}
								//라인그리기[S]
								polyline_ = new Tmapv2.Polyline({
									path: sectionPoint,
									strokeColor: lineColor,
									strokeWeight: 6,
									map: map
								});
								//라인그리기[E]
								resultdrawArr.push(polyline_);
							}
						}
					}
				} else {

				}
			} else {
				polyline_ = new Tmapv2.Polyline({
					path: arrPoint,
					strokeColor: "#DD0000",
					strokeWeight: 6,
					map: map
				});
				resultdrawArr.push(polyline_);
			}
		}

		//초기화 기능
		function resettingMap() {
			//기존마커는 삭제
			marker_s.setMap(null);
			marker_e.setMap(null);

			if (resultMarkerArr.length > 0) {
				for (var i = 0; i < resultMarkerArr.length; i++) {
					resultMarkerArr[i].setMap(null);
				}
			}

			if (resultdrawArr.length > 0) {
				for (var i = 0; i < resultdrawArr.length; i++) {
					resultdrawArr[i].setMap(null);
				}
			}
			chktraffic = [];
			drawInfoArr = [];
			resultMarkerArr = [];
			resultdrawArr = [];
		}


		//달력 기능.
		document.addEventListener("DOMContentLoaded", function () {
			var showCalendarBtn = document.getElementById('showCalendarBtn');
			var closeCalendarBtn = document.getElementById('closeCalendarBtn');
			var calendar = document.getElementById('calendar');
			var selectedDateInput = document.getElementById('selectedDate');
			var selectedDateDisplay = document.getElementById('selectedDateDisplay');

			// 달력 열기 버튼 클릭 이벤트
			showCalendarBtn.addEventListener('click', function () {
				calendar.style.display = 'block';
			});

			// 전체화면으로 보이기
			aspectRatio: 2

			// 닫기 버튼 클릭 이벤트
			closeCalendarBtn.addEventListener('click', function () {
				calendar.style.display = 'none';
			});

			// 날짜 선택 시 이벤트
			selectedDateInput.addEventListener('change', function () {
				var selectedDate = selectedDateInput.value;
				showCalendarBtn.innerHTML = "여행 시작일 : <div id='selectedDateDisplay'>" + selectedDate + "</div>";
				calendar.style.display = 'none'; // 달력 숨기기

			});
		});



		//여행지 추가하기(마커추가) start
		function addTour(lonlat) {
			removeMarkers();

			// 마커를 찍은 위치의 경도와 위도 값을 가져와서 변수에 저장
			var longitude = lonlat.lng();
			var latitude = lonlat.lat();

			// 숨겨진 필드에 해당 값 할당
			document.getElementById("longtitue").value = longitude;
			document.getElementById("lattitue").value = latitude;

			marker = new Tmapv2.Marker({
				position: new Tmapv2.LatLng(lonlat.lat(), lonlat.lng()),
				map: map
			});

			console.log("점찍은 위치:" + lonlat);
			markers.push(marker);

		}

		function removeMarkers() {
			for (var i = 0; i < markers.length; i++) {
				markers[i].setMap(null);
			}
			markers = [];
		}


		function toggleAddTour() {
			addTourEnabled = !addTourEnabled;
			console.log("여행지 추가 모드: " + (addTourEnabled ? "활성화" : "비활성화")); // 여행지 추가 모드 상태를 콘솔에 출력
			if (addTourEnabled) {
				alert("여행지 추가 모드가 활성화되었습니다. 지도를 클릭하여 여행지를 추가하세요. 여행지추가 버튼을 한 번 더 누르시면 모드가 비활성화 됩니다");
				map.addListener("click", function (e) {
					addTourScreen(e.latLng); // 클릭한 위치를 전달하여 화면을 표시합니다.
				}, {passive: true});
			} else {
				alert("여행지 추가 모드가 비활성화되었습니다.");
				setTimeout(removeMarkers, 0);

				hideAddTourScreen(); // 여행지 추가 모드가 비활성화될 때 화면을 숨깁니다.
			}
		}


		// 화면을 표시하는 함수
		function addTourScreen(latlng) {
			var addTourScreen = document.getElementById("addTourScreen");
			addTourScreen.style.display = "block";

			// "추가" 버튼 클릭 시
			document.getElementById('addToTourVO').onclick = function () {
				// 여기에 추가 버튼을 클릭했을 때 수행할 동작을 작성합니다.
				console.log("여행지가 추가되었습니다.");
				addTourEnabled = false; // 모드를 비활성화합니다.
				addTourScreen.style.display = "none"; // 화면을 숨깁니다.
				addTour(latlng); // 여행지를 추가하는 함수를 호출합니다.

				// 모달 열기
				var modal = new bootstrap.Modal(document.getElementById('exampleModal'));
				modal.show();
			};
			document.getElementById('cancelToTourVO').onclick = function () {
				hideAddTourScreen();

			};

		}

		// 화면을 숨기는 함수
		function hideAddTourScreen() {
			var addTourScreen = document.getElementById("addTourScreen");
			addTourScreen.style.display = "none";
		}


		//여행지 추가 모달 start
		var exampleModal = document.getElementById('exampleModal')
		exampleModal.addEventListener('show.bs.modal', function (event) {
			// Button that triggered the modal
			var button = event.relatedTarget
			// Extract info from data-bs-* attributes
			var recipient = button.getAttribute('data-bs-whatever')
			// If necessary, you could initiate an AJAX request here
			// and then do the updating in a callback.
			//
			// Update the modal's content.
			var modalTitle = exampleModal.querySelector('.modal-title')
			var modalBodyInput = exampleModal.querySelector('.modal-body input')

			modalTitle.textContent = 'New message to ' + recipient
			modalBodyInput.value = recipient
			//여행지 추가 모달 end
		})
	</script>
</head>

<body onload="initTmap()">
	<div id="sidebar">
		<button id="showCalendarBtn">여행 시작일 : 2024-04-08</button>
		<div id="calendar">
			<input type="date" id="selectedDate">
			<button id="closeCalendarBtn">닫기</button>
		</div>

		<!-- 여행 기간 표시 영역 -->
		<div id="selectedDuration"></div>

	</div>

	<div id="smallScreen">
		<div id="placeName"></div>
		<div id="placeDescription"></div>
		<button id="addToSidebarButton">Add to Sidebar</button>
	</div>

	<!-- 맵 생성 실행 -->
	<div id="map_wrap" class="map_wrap">
		<div id="map_div"></div>
	</div>
	<div class="map_result">
	</div>
	<br />

	<button id="saveItineraryButton" class="savebutton">여행 일정 저장</button>
	<!--	<button id="addTour" onclick="addTour()">여행지 추가</button>-->
	<button id="addTour" onclick="toggleAddTour()">여행지 추가</button>

	<!--마커가 찍힌곳에 여행지로 등록하기-->
	<div id="addTourScreen">
		<div>
			<h1>여행지 목록에 추가 하시겠습니까?</h1>
		</div>
		<button id="addToTourVO">추가</button>
		<button id="cancelToTourVO">취소</button>
	</div>

	


	<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">New message</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="addTourForm">
						<div class="mb-3">
							<label for="tourName" class="col-form-label">여행지 이름:</label>
							<input type="text" class="form-control" id="tourName" name="tourName">
						</div>
						<div class="mb-3">
							<label for="tourAddress" class="col-form-label">여행지 주소:</label>
							<input type="text" class="form-control" id="tourAddress" name="tourAddress">
						</div>
						<div class="mb-3">
							<label for="tourContent" class="col-form-label">여행지 설명:</label>
							<textarea class="form-control" id="tourContent" name="tourContent"></textarea>
						</div>
						<div class="mb-3">
							<label for="tourTel" class="col-form-label">여행지 연락처(선택):</label>
							<input type="text" class="form-control" id="tourTel" name="tourTel">
						</div>
						<div class="mb-3">
							<label for="tourImg" class="col-form-label">이미지 URL:</label>
							<input type="file" class="form-control" id="tourImg" name="tourImg">
						</div>
						<!-- 경도와 위도는 숨겨진 필드로 자동으로 설정됩니다 -->
						<input type="hidden" id="longtitue" name="longtitue">
						<input type="hidden" id="lattitue" name="lattitue">
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary">Send message</button>
				</div>
			</div>
		</div>
	</div>
	<!--모달: 여행지 추가 form end-->

</body>

</html>