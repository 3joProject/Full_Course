<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>simpleMap</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=6VYbMDkEY24DlbC0m8ymh1ESimWVROyI3sP7PqT1"></script>
<script type="text/javascript">
	var map, myMarker;
	// 페이지가 로딩이 된 후 호출하는 함수입니다.
	function initTmap() {
		// map 생성
		// Tmapv2.Map을 이용하여, 지도가 들어갈 div, 넓이, 높이를 설정합니다
		map = new Tmapv2.Map("map_div", {
			center: new Tmapv2.LatLng(37.56520450, 126.98702028),
			width: "100%",	// 지도의 넓이
			height: "1200px",	// 지도의 높이
			zoom: 17	// 지도 줌레벨
		});

		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(
				function (position) {
					var myLat = position.coords.latitude;
					var myLon = position.coords.longitude;
					console.log("myLat", myLat);
					console.log("myLon", myLon);

					//팝업 생성
					var content = "<div style=' position: relative; border-bottom: 1px solid #dcdcdc; line-height: 18px; padding: 0 35px 2px 0;'>"
						+ "<div style='font-size: 12px; line-height: 15px;'>"
						+ "<span style='display: inline-block; width: 14px; height: 14px; background-image: url(/resources/images/common/icon_blet.png); vertical-align: middle; margin-right: 5px;'></span>현재위치"
						+ "</div>" + "</div>";

					myMarker = new Tmapv2.Marker({
						position: new Tmapv2.LatLng(myLat, myLon),
						map: map
					});
					InfoWindow = new Tmapv2.InfoWindow({
						position: new Tmapv2.LatLng(myLat, myLon),
						content: content,
						offset: new Tmapv2.Point(0, 30),
						type: 2,
						map: map
					});
					map.setCenter(new Tmapv2.LatLng(myLat, myLon));
					map.setZoom(1);

					// 지도 객체 생성 후 마커를 등록하는 함수를 수행합니다.
					addParkingMarkers(myLat, myLon);
					


				});


		}

		map.addListener("dragend", onDragend); // 지도 드래그 끝났을 때, 이벤트 리스너 등록.




	}
	//처음위치로 이동하는 함수입니다.
	function Move() {
		var lonlat = new Tmapv2.LatLng(37.56520450, 126.98702028);
		map.setCenter(lonlat); // 지도의 중심 좌표를 설정합니다.
	}



	//드래그 끝났을 때
	function onDragend(e) {
		var result = '드래그가 끝난 위치의 중앙좌표는' + e.latLng + '입니다.';
		var resultDiv = document.getElementById("result");
		var newLat = e.latLng.lat();
		var newLng = e.latLng.lng();
		resultDiv.innerHTML = result;

		addParkingMarkers(newLat, newLng);
	}

	// 마커들을 저장할 배열입니다.
	var markers = [];


	// 모든 마커를 제거하는 함수입니다.
	function removeMarkers() {
		for (var i = 0; i < markers.length; i++) {
			markers[i].setMap(null);
		}
		markers = [];
	}


	function addParkingMarkers(lat, lng) {
		console.log("addParkingMarkers");
		removeMarkers();
		$.ajax({
			url: "/api/parking",
			data: {lat: lat, lng: lng},
			type: "get",
			dataType: "json",
			success: function (vos) {
				console.log(vos);
				for (var i = 0; i < vos.length; i++) {
					var vo = vos[i]
					console.log("vo", vo);
					//Marker 객체 생성.
					var parking = new Tmapv2.Marker({
						position: new Tmapv2.LatLng(vo.prkPlceEntrcLa, vo.prkPlceEntrcLo), //Marker의 중심좌표 설정.
						label: vo.prkPlceNm + '' + '주차장'//Marker의 라벨.
					});
					parking.setMap(map); //Marker가 표시될 Map 설정.
					markers.push(parking);
				}
			}, error: function () {

			}

		});

	}

</script>

</head>

<body onload="initTmap()"><!-- 맵 생성 실행 -->
	<div id="map_div"></div>
	<button onClick="Move()">처음 위치로 지도 이동</button>
	<p id="result" />
	</div>
</body>

</html>